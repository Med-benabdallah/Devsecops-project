pipeline {
    agent any

    tools {
        // keep your Maven tool name
        maven 'M2_HOME'
    }

    environment {
        // keep your credential id
        SONAR_TOKEN = credentials('devsecops')
        IMAGE_NAME  = 'my-app'   // Docker image name used in the Trivy image scan + DAST
        APP_PORT    = '9001'     // change if your app exposes a different port
    }

    stages {
        // ---------- YOUR EXISTING STAGES (unchanged) ----------
        stage('Build') {
            steps {
                dir('simple-java-maven-app') {
                    sh 'mvn -B clean install'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir('simple-java-maven-app') {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                            mvn clean verify sonar:sonar \
                              -Dsonar.projectKey=my-app \
                              -Dsonar.host.url=http://localhost:9000 \
                              -Dsonar.token=$SONAR_TOKEN \
                              -Dsonar.qualitygate.wait=true
                        '''
                    }
                }
            }
        }

        stage('Dependency Scan') {
            steps {
                dir('simple-java-maven-app') {
                    sh 'mvn org.owasp:dependency-check-maven:check -DfailOnCVSS=7'
                }
            }
        }
        // ------------------------------------------------------

        // ---------- Secrets Scan (Gitleaks) ----------
        stage('Secrets Scan - Gitleaks') {
            steps {
                sh '''#!/bin/bash
set -euo pipefail
mkdir -p tools reports

GITLEAKS_VER="v8.18.4"
URL="https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VER}/gitleaks_${GITLEAKS_VER#v}_linux_x64.tar.gz"

# Download gitleaks
curl -sSL "$URL" | tar -xz -C tools
chmod +x tools/gitleaks || true

# Blocking scan (fails pipeline on findings)
./tools/gitleaks detect \
  --source . \
  --report-format sarif \
  --report-path reports/gitleaks.sarif \
  --exit-code 1

# Non-blocking JSON report (for artifacts/visibility)
./tools/gitleaks detect \
  --source . \
  --report-format json \
  --report-path reports/gitleaks.json \
  --exit-code 0
'''
            }
        }

        // ---------- Docker Image Scan (Trivy) ----------
        stage('Docker Scan - Trivy') {
            steps {
                sh '''#!/bin/bash
set -euo pipefail
mkdir -p tools reports

# Install trivy locally if not present
if ! command -v trivy >/dev/null 2>&1; then
  TRIVY_VER="0.53.0"
  curl -sSL -o tools/trivy.tgz "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VER}/trivy_${TRIVY_VER}_Linux-64bit.tar.gz"
  tar -xzf tools/trivy.tgz -C tools trivy
  chmod +x tools/trivy
  export PATH="$PWD/tools:$PATH"
fi

if command -v docker >/dev/null 2>&1; then
  echo "Docker found â†’ building image and running image scan..."
  docker build -t "${IMAGE_NAME}:${BUILD_NUMBER}" simple-java-maven-app

  # Fail on HIGH/CRITICAL vulns in the image
  trivy image --exit-code 1 --severity HIGH,CRITICAL --no-progress \
    "${IMAGE_NAME}:${BUILD_NUMBER}" | tee reports/trivy-image.txt
else
  echo "Docker not found â†’ skipping image build; running filesystem scan (non-blocking)."
  # Produce a report but don't fail the build
  trivy fs --severity HIGH,CRITICAL --no-progress . | tee reports/trivy-fs.txt || true
fi
'''
            }
        }

        // ---------- Start app in Docker for DAST ----------
        stage('Start Staging App (Docker)') {
            steps {
                sh '''#!/bin/bash
set -euo pipefail

# Create an isolated network for DAST if it doesn't exist
docker network inspect dast_net >/dev/null 2>&1 || docker network create dast_net

# Stop any previous container with the same name
docker rm -f app-under-test >/dev/null 2>&1 || true

# Run the app container on the network and publish the port for visibility
docker run -d --name app-under-test --network dast_net -p "${APP_PORT}:${APP_PORT}" \
  "${IMAGE_NAME}:${BUILD_NUMBER}"

# Wait until the app responds via the container network (resolves by container name)
echo "Waiting for app-under-test:${APP_PORT} to be ready..."
for i in {1..30}; do
  if docker run --rm --network dast_net curlimages/curl:8.10.1 -fsS \
       "http://app-under-test:${APP_PORT}" >/dev/null; then
    echo "âœ… App is up."
    exit 0
  fi
  echo "â€¦still starting ($i/30)"
  sleep 3
done

echo "âŒ App did not become ready in time."
docker logs --tail=200 app-under-test || true
exit 1
'''
            }
        }

        // ---------- DAST: OWASP ZAP Baseline (Docker â†’ Docker) ----------
        stage('DAST - OWASP ZAP Baseline (Docker)') {
            steps {
                sh '''#!/bin/bash
set -euo pipefail
mkdir -p reports

TARGET="http://app-under-test:${APP_PORT}"
echo "Running ZAP Baseline against: ${TARGET}"

docker run --rm -t \
  --network dast_net \
  -v "$PWD/reports:/zap/wrk" \
  owasp/zap2docker-stable zap-baseline.py \
    -t "${TARGET}" \
    -J /zap/wrk/zap-baseline.json \
    -w /zap/wrk/zap-warn.md \
    -x /zap/wrk/zap-report.xml \
    -r /zap/wrk/zap-report.html \
    -I   # non-blocking; remove -I later to FAIL the build on alerts
'''
            }
        }

        // ---------- Stop & cleanup ----------
        stage('Stop Staging App (Docker)') {
            steps {
                sh '''#!/bin/bash
set -euo pipefail
docker rm -f app-under-test >/dev/null 2>&1 || true
docker network rm dast_net >/dev/null 2>&1 || true
echo "ğŸ§¹ Cleaned up app and network."
'''
            }
        }
    }

    post {
        always {
            // Archive reports from the new stages + Dependency-Check defaults
            archiveArtifacts artifacts: 'reports/*, simple-java-maven-app/target/dependency-check-report.*', onlyIfSuccessful: false
            // If you run tests, publish JUnit (won't fail if none)
            junit allowEmptyResults: true, testResults: 'simple-java-maven-app/target/surefire-reports/*.xml'
        }
        success {
            echo 'âœ… Pipeline completed successfully!'
        }
        failure {
            echo 'âŒ Pipeline failed â€” check the console output for details.'
        }
    }
}

